{% extends "base.html" %}

{% block title %}Wiki Generator - {{ project_name }}{% endblock %}

{% block content %}
<div class="wiki-generator-page">
    <header class="page-header">
        <h1>Wiki Generator</h1>
        <p class="subtitle">Generate professional GitHub Wiki documentation with navigation and footers</p>
    </header>

    <div class="tool-container">
        <!-- Wiki Configuration -->
        <section class="section card">
            <h2>[DOCS] Wiki Configuration</h2>

            <div class="form-group">
                <label>Select Pages to Generate:</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" value="Home" checked> Home</label>
                    <label><input type="checkbox" value="Installation" checked> Installation</label>
                    <label><input type="checkbox" value="Usage" checked> Usage</label>
                    <label><input type="checkbox" value="API-Reference" checked> API Reference</label>
                    <label><input type="checkbox" value="Contributing" checked> Contributing</label>
                    <label><input type="checkbox" value="FAQ" checked> FAQ</label>
                </div>
            </div>

            <button id="generateWikiBtn" class="btn btn-primary">
                <span class="btn-icon">[ROCKET]</span> Generate Wiki Pages
            </button>
        </section>

        <!-- Generated Pages -->
        <section class="section card" id="wikiPagesSection" style="display: none;">
            <h2>[OK] Generated Wiki Pages</h2>
            <div id="wikiPagesList"></div>
            <div class="wiki-actions">
                <button class="btn btn-secondary" id="downloadAllWiki">
                    <span class="btn-icon">[PKG]</span> Download All Pages
                </button>
            </div>
        </section>

        <!-- GitHub Wiki Setup Instructions -->
        <section class="section card">
            <h2>[!] GitHub Wiki Setup Instructions</h2>
            <div class="setup-instructions">
                <p><strong>[WARN] Your wiki pages are ready! But first, enable Wiki in GitHub:</strong></p>

                <div class="step">
                    <h3>Step 1: Go to Repository Settings</h3>
                    <p>Navigate to your repository on GitHub and click "Settings"</p>
                </div>

                <div class="step">
                    <h3>Step 2: Scroll to 'Features' section</h3>
                    <p>Find the Features section in the settings page</p>
                </div>

                <div class="step">
                    <h3>Step 3: Check the 'Wikis' checkbox</h3>
                    <p>Enable the Wikis feature for your repository</p>
                </div>

                <div class="step">
                    <h3>Step 4: Initialize Wiki</h3>
                    <p>Go to the Wiki tab and click "Create the first page"</p>
                    <p>Add any content and save (we'll replace it with generated pages)</p>
                </div>

                <div class="step">
                    <h3>Step 5: Clone Wiki Repository</h3>
                    <pre><code>git clone https://github.com/username/repo.wiki.git</code></pre>
                </div>

                <div class="step">
                    <h3>Step 6: Copy Generated Pages</h3>
                    <p>Copy your downloaded wiki files into the cloned wiki directory</p>
                </div>

                <div class="step">
                    <h3>Step 7: Commit and Push</h3>
                    <pre><code>cd repo.wiki
git add .
git commit -m "Update wiki pages"
git push origin master</code></pre>
                </div>

                <p class="success-message">[OK] Once complete, your wiki will be live!</p>
            </div>
        </section>
    </div>
</div>

<style>
.wiki-generator-page {
    max-width: 1200px;
    margin: 0 auto;
}

.tool-container {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 2rem;
}

.checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}

.checkbox-group label {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    background: var(--darker-bg);
    border-radius: 4px;
    cursor: pointer;
}

.checkbox-group input[type="checkbox"] {
    margin-right: 0.5rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-icon {
    margin-right: 0.5rem;
}

.btn-primary {
    background: var(--primary-color);
    color: var(--dark-bg);
}

.btn-primary:hover {
    background: var(--secondary-color);
}

.btn-secondary {
    background: var(--card-bg);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    margin-right: 0.5rem;
}

.btn-secondary:hover {
    border-color: var(--primary-color);
}

#wikiPagesList {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.wiki-page-card {
    background: var(--darker-bg);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 1rem;
}

.wiki-page-card h3 {
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}

.wiki-page-card button {
    margin-top: 0.5rem;
}

.setup-instructions {
    font-size: 0.95rem;
}

.step {
    margin: 1.5rem 0;
    padding: 1rem;
    background: var(--darker-bg);
    border-left: 3px solid var(--primary-color);
    border-radius: 4px;
}

.step h3 {
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}

.step pre {
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 0.75rem;
    overflow-x: auto;
    margin-top: 0.5rem;
}

.step code {
    color: var(--text-primary);
    font-family: 'Courier New', monospace;
}

.success-message {
    color: var(--success-color, #4caf50);
    font-weight: bold;
    margin-top: 1rem;
}

.wiki-actions {
    margin-top: 1rem;
}
</style>

<script>
let generatedPages = [];

// Generate wiki pages
document.getElementById('generateWikiBtn').addEventListener('click', async () => {
    const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked');
    const selectedPages = Array.from(checkboxes).map(cb => cb.value);

    if (selectedPages.length === 0) {
        showNotification('Please select at least one page to generate', 'error');
        return;
    }

    try {
        const response = await fetch('/api/generate-wiki', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pages: selectedPages })
        });

        const result = await response.json();

        if (result.success) {
            generatedPages = result.pages;
            displayWikiPages(result.pages);
            document.getElementById('wikiPagesSection').style.display = 'block';
            showNotification(`${result.pages.length} wiki pages generated successfully!`, 'success');
        } else {
            showNotification('Failed to generate wiki: ' + result.error, 'error');
        }
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
    }
});

function displayWikiPages(pages) {
    const container = document.getElementById('wikiPagesList');
    container.innerHTML = '';

    pages.forEach((page, index) => {
        const card = document.createElement('div');
        card.className = 'wiki-page-card';
        card.innerHTML = `
            <h3>[DOCS] ${page.name}</h3>
            <p><strong>File:</strong> ${page.filename}</p>
            <p><strong>Size:</strong> ${page.content.length} characters</p>
            <button class="btn btn-secondary" onclick="downloadWikiPage(${index})">
                <span class="btn-icon">[PKG]</span> Download
            </button>
            <button class="btn btn-secondary" onclick="viewWikiPage(${index})">
                <span class="btn-icon">[>>]</span> View
            </button>
        `;
        container.appendChild(card);
    });
}

function downloadWikiPage(index) {
    const page = generatedPages[index];
    const blob = new Blob([page.content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = page.filename;
    a.click();
    URL.revokeObjectURL(url);
    showNotification(`${page.filename} downloaded!`, 'success');
}

function viewWikiPage(index) {
    const page = generatedPages[index];
    const newWindow = window.open('', '_blank');
    newWindow.document.write(`
        <html>
        <head>
            <title>${page.name}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 2rem; background: #1e1e1e; color: #e0e0e0; }
                pre { background: #2d2d2d; padding: 1rem; border-radius: 4px; overflow-x: auto; }
            </style>
        </head>
        <body>
            <h1>${page.name}</h1>
            <pre>${page.content}</pre>
        </body>
        </html>
    `);
}

// Download all wiki pages
document.getElementById('downloadAllWiki').addEventListener('click', () => {
    generatedPages.forEach(page => {
        const blob = new Blob([page.content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = page.filename;
        a.click();
        URL.revokeObjectURL(url);
    });
    showNotification('All wiki pages downloaded!', 'success');
});

function showNotification(message, type) {
    if (window.GitSage && window.GitSage.showNotification) {
        window.GitSage.showNotification(message, type);
    } else {
        alert(message);
    }
}
</script>
{% endblock %}
